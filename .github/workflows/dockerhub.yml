name: dockerhub
on:
  push:
    branches: [ main ]
    tags: [ 'v*', 'base-v*' ]
jobs:
  build-base:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/base-v')
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          registry: https://index.docker.io/v1/
      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/base-v}" >> $GITHUB_OUTPUT
      - name: Build and push base
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.base
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-base:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-base:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
  test-base:
    runs-on: ubuntu-latest
    needs: build-base
    if: startsWith(github.ref, 'refs/tags/base-v')
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          registry: https://index.docker.io/v1/
      - name: Pull latest base image
        run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-base:latest
      - name: Verify ImageMagick version
        run: docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-base:latest magick -version
      - name: Verify delegates and formats
        run: |
          docker run --rm ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-base:latest sh -lc "magick -list format | egrep 'RAW|ARW|CR2|CR3|NEF|ORF|RW2|RAF|DNG|JP2|HEIC|SVG|PDF' || true"
  
  build-api:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          registry: https://index.docker.io/v1/
      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            BASE_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-base:latest
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-full-delegates-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/imagemagick-full-delegates-api:v2
          cache-from: type=gha
          cache-to: type=gha,mode=max


